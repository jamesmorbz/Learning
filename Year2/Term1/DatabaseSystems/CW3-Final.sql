CREATE TABLE TICKET
       (TICKETID SMALLINT NOT NULL,
        PASSENGERTYPE VARCHAR(20),
        PRICE SMALLINT,
        PRIMARY KEY(TICKETID));     
             
INSERT INTO TICKET VALUES (7771, 'STANDARD', 80);
INSERT INTO TICKET VALUES (7772, 'STANDARD PREMIER', 150);
INSERT INTO TICKET VALUES (7773, 'BUSINESS PREMIER', 250);
INSERT INTO TICKET VALUES (7774, 'STUDENT', 40);
INSERT INTO TICKET VALUES (7775, 'CHILD', 20);

CREATE TABLE EMPLOYEE
       (EMPLOYEEID SMALLINT NOT NULL,
        NAME VARCHAR(10),
        PRIMARY KEY(EMPLOYEEID));
                        
INSERT INTO EMPLOYEE VALUES (5551, 'GREALISH');
INSERT INTO EMPLOYEE VALUES (5552, 'KANE');
INSERT INTO EMPLOYEE VALUES (5553, 'SAKA');
INSERT INTO EMPLOYEE VALUES (5554, 'FODEN');
INSERT INTO EMPLOYEE VALUES (5555, 'RASHFORD');
INSERT INTO EMPLOYEE VALUES (5556, 'STERLING');
INSERT INTO EMPLOYEE VALUES (5557, 'MAGUIRE');
INSERT INTO EMPLOYEE VALUES (5558, 'BELLINGHAM');
INSERT INTO EMPLOYEE VALUES (5559, 'MOUNT');
INSERT INTO EMPLOYEE VALUES (5560, 'PICKFORD');
INSERT INTO EMPLOYEE VALUES (5561, 'POPE');
INSERT INTO EMPLOYEE VALUES (5562, 'GALLAGHER');
INSERT INTO EMPLOYEE VALUES (5563, 'STONES');
INSERT INTO EMPLOYEE VALUES (5564, 'COADY');    

CREATE TABLE STATION
       (STATIONID SMALLINT NOT NULL,
        NAME VARCHAR(20),
        COUNTRY VARCHAR(20),
        PRIMARY KEY(STATIONID));

INSERT INTO STATION VALUES (6661, 'LONDON ST PANCRAS', 'ENGLAND');
INSERT INTO STATION VALUES (6662, 'CALAIS', 'FRANCE');
INSERT INTO STATION VALUES (6663, 'PARIS', 'FRANCE');
INSERT INTO STATION VALUES (6664, 'MARNE-LA-VILLE', 'FRANCE');
INSERT INTO STATION VALUES (6665, 'LYON', 'FRANCE');
INSERT INTO STATION VALUES (6666, 'BRUGES', 'BELGIUM');
INSERT INTO STATION VALUES (6667, 'BERLIN', 'GERMANY');
INSERT INTO STATION VALUES (6668, 'LILLE', 'FRANCE');
INSERT INTO STATION VALUES (6669, 'BRUSSELS', 'BELGIUM');
INSERT INTO STATION VALUES (6670, 'AMSTERDAM', 'NETHERLANDS');
INSERT INTO STATION VALUES (6671, 'ROTTERDAM', 'NETHERLANDS');

CREATE TABLE CREW
       (CREWID SMALLINT NOT NULL,
        DRIVER1 SMALLINT,
        DRIVER2 SMALLINT,
        HEADCONDUCTOR SMALLINT,
        SECONDCONDUCTOR SMALLINT,
        SECUIRITYGUARD1 SMALLINT,
        SECUIRITYGUARD2 SMALLINT,
        SERVICEMEMBER SMALLINT,
        CONSTRAINT FKDRIVER1 FOREIGN KEY (DRIVER1) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKDRIVER2 FOREIGN KEY (DRIVER2) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKHEADCONDUCTOR FOREIGN KEY (HEADCONDUCTOR) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKSECONDCONDUCTOR FOREIGN KEY (SECONDCONDUCTOR) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKSECUIRITYGUARD1 FOREIGN KEY (SECUIRITYGUARD1) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKSECUIRITYGUARD2 FOREIGN KEY (SECUIRITYGUARD2) REFERENCES EMPLOYEE(EMPLOYEEID),
        CONSTRAINT FKSERVICEMEMBER FOREIGN KEY (SERVICEMEMBER) REFERENCES EMPLOYEE(EMPLOYEEID),
        PRIMARY KEY(CREWID));
                
INSERT INTO CREW VALUES (0001, 5551, 5552, 5553, 5554, 5555, 5556, 5557);
INSERT INTO CREW VALUES (0002, 5558, 5559, 5560, 5561, 5562, 5563, 5564);

CREATE TABLE TRAIN
       (TRAINID SMALLINT NOT NULL,
        CREWID SMALLINT NOT NULL,
        ISOPERTING CHAR,
        ISMODERN CHAR,
        CAPACITY SMALLINT CHECK(CAPACITY <= 900),
        CONSTRAINT FKCREWID FOREIGN KEY (CREWID) REFERENCES CREW(CREWID),
        PRIMARY KEY(TRAINID));

INSERT INTO TRAIN VALUES (1111, 0001, 'Y', 'N', 900);
INSERT INTO TRAIN VALUES (1112, 0002, 'Y', 'Y', 800);
INSERT INTO TRAIN VALUES (1113, 0001, 'Y', 'Y', 700);
INSERT INTO TRAIN VALUES (1114, 0002, 'Y', 'N', 850);
INSERT INTO TRAIN VALUES (1115, 0001, 'Y', 'N', 750);
INSERT INTO TRAIN VALUES (1116, 0002, 'N', 'N', 650);
INSERT INTO TRAIN VALUES (1117, 0001, 'N', 'Y', 600);
INSERT INTO TRAIN VALUES (1118, 0002, 'N', 'Y', 700);
INSERT INTO TRAIN VALUES (1119, 0002, 'N', 'N', 800);
INSERT INTO TRAIN VALUES (1120, 0001, 'N', 'Y', 900);

INSERT INTO TRAIN VALUES (1121, 0001, 'Y', 'N', 900);
INSERT INTO TRAIN VALUES (1122, 0002, 'Y', 'Y', 800);
INSERT INTO TRAIN VALUES (1123, 0001, 'Y', 'Y', 700);
INSERT INTO TRAIN VALUES (1124, 0002, 'Y', 'N', 850);
INSERT INTO TRAIN VALUES (1125, 0001, 'Y', 'N', 750);
INSERT INTO TRAIN VALUES (1126, 0002, 'N', 'N', 650);
INSERT INTO TRAIN VALUES (1127, 0001, 'N', 'Y', 600);
INSERT INTO TRAIN VALUES (1128, 0002, 'N', 'Y', 700);
INSERT INTO TRAIN VALUES (1129, 0002, 'N', 'N', 800);
INSERT INTO TRAIN VALUES (1130, 0001, 'N', 'Y', 900);

CREATE TABLE ROUTE
       (ROUTEID SMALLINT NOT NULL,
        STARTSTATION SMALLINT NOT NULL,
        ENDSTATION SMALLINT NOT NULL,
        ROUTEDISTANCE SMALLINT,
        ROUTETIME SMALLINT,
        OPERATIONSTATUS CHAR,
	ISMODERN CHAR,
        CONSTRAINT FKSTARTSTATION FOREIGN KEY (STARTSTATION) REFERENCES STATION(STATIONID),
	    CONSTRAINT FKENDSTATION FOREIGN KEY (ENDSTATION) REFERENCES STATION(STATIONID),
        PRIMARY KEY(ROUTEID));
       
INSERT INTO ROUTE VALUES (3331, 6661, 6663, 306 , 170, 'Y', 'N');
INSERT INTO ROUTE VALUES (3332, 6666, 6663, 150 , 80, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3333, 6662, 6668, 320 , 190, 'Y', 'N');
INSERT INTO ROUTE VALUES (3334, 6663, 6664, 230 , 130, 'N', 'N');
INSERT INTO ROUTE VALUES (3335, 6664, 6669, 120 , 70, 'Y', 'N');
INSERT INTO ROUTE VALUES (3336, 6666, 6662, 420 , 230, 'N', 'N');
INSERT INTO ROUTE VALUES (3337, 6662, 6665, 460 , 250, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3338, 6664, 6661, 480, 270, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3339, 6663, 6667, 280 , 150, 'Y', 'N');
INSERT INTO ROUTE VALUES (3340, 6661, 6671, 310 , 180, 'Y', 'Y');

INSERT INTO ROUTE VALUES (3341, 6666, 6662, 306 , 170, 'Y', 'N');
INSERT INTO ROUTE VALUES (3342, 6667, 6664, 150 , 80, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3343, 6667, 6668, 320 , 190, 'Y', 'N');
INSERT INTO ROUTE VALUES (3344, 6668, 6666, 230 , 130, 'N', 'N');
INSERT INTO ROUTE VALUES (3345, 6666, 6669, 120 , 70, 'Y', 'N');
INSERT INTO ROUTE VALUES (3346, 6669, 6667, 420 , 230, 'N', 'N');
INSERT INTO ROUTE VALUES (3347, 6665, 6670, 460 , 250, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3348, 6671, 6666, 480, 270, 'Y', 'Y');
INSERT INTO ROUTE VALUES (3349, 6671, 6667, 280 , 150, 'Y', 'N');
INSERT INTO ROUTE VALUES (3350, 6670, 6671, 310 , 180, 'Y', 'Y');

CREATE TABLE STATIONS_BETWEEN_ROUTE
       (BETWEENID SMALLINT NOT NULL ,
        ROUTEID SMALLINT NOT NULL, 
        STATIONID SMALLINT NOT NULL,
        STATIONORDER SMALLINT NOT NULL, 
        FOREIGN KEY (ROUTEID) REFERENCES ROUTE(ROUTEID),
        FOREIGN KEY (STATIONID) REFERENCES STATION(STATIONID),
        CONSTRAINT DIFFERENTSTATION UNIQUE(ROUTEID, STATIONID),
        CONSTRAINT DIFFERENTORDER UNIQUE(ROUTEID, STATIONORDER),
        PRIMARY KEY(BETWEENID)); 

INSERT INTO STATIONS_BETWEEN_ROUTE VALUES (1,3331,6661,1);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES (2,3331,6662,2);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(3,3331,6663,3);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(4,3331,6664,4);

INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(5,3332,6664,1);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(6,3332,6665,2);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(7,3332,6666,3);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(8,3332,6667,4);

INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(9,3333,6666,1);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(10,3333,6667,2);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(11,3333,6668,3);
INSERT INTO STATIONS_BETWEEN_ROUTE VALUES(12,3333,6669,4);

CREATE TABLE JOURNEY
       (JOURNEYID SMALLINT NOT NULL,
        TRAINID SMALLINT NOT NULL,
        ROUTEID SMALLINT NOT NULL,
        DEPARTURETIME TIMESTAMP,
        ARRIVALTIME TIMESTAMP,
        FOREIGN KEY (TRAINID) REFERENCES TRAIN(TRAINID), 
        FOREIGN KEY (ROUTEID) REFERENCES ROUTE(ROUTEID),
        PRIMARY KEY(JOURNEYID)); 

CREATE MATERIALIZED VIEW MODERN_CHECK
        REFRESH COMPLETE ON COMMIT 
    AS 
        SELECT J.TRAINID, J.ROUTEID, R.ISMODERN AS MODERN_ROUTE, T.ISMODERN AS MODERN_TRAIN FROM JOURNEY J, ROUTE R, TRAIN T
        WHERE J.TRAINID = T.TRAINID AND J.ROUTEID=R.ROUTEID; 

ALTER TABLE MODERN_CHECK
    ADD CONSTRAINT MODERNCK CHECK(NOT(MODERN_ROUTE='Y' AND MODERN_TRAIN ='N'));  
        
INSERT INTO JOURNEY VALUES (2221, 1111, 3331, TO_TIMESTAMP('03-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('03-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2222, 1112, 3332, TO_TIMESTAMP('04-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('04-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2223, 1113, 3333, TO_TIMESTAMP('05-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('05-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2224, 1112, 3334, TO_TIMESTAMP('06-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('06-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2225, 1115, 3335, TO_TIMESTAMP('07-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('07-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2226, 1116, 3336, TO_TIMESTAMP('08-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('08-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2227, 1117, 3337, TO_TIMESTAMP('09-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('09-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2228, 1118, 3338, TO_TIMESTAMP('10-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('10-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2229, 1119, 3339, TO_TIMESTAMP('11-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('11-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2230, 1120, 3340, TO_TIMESTAMP('13-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('13-AUG-17 2:20:30.45 PM'));

INSERT INTO JOURNEY VALUES (2231, 1121, 3341, TO_TIMESTAMP('14-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('14-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2232, 1122, 3342, TO_TIMESTAMP('15-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('15-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2233, 1123, 3343, TO_TIMESTAMP('16-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('16-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2234, 1122, 3344, TO_TIMESTAMP('17-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('17-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2235, 1125, 3345, TO_TIMESTAMP('18-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('18-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2236, 1126, 3346, TO_TIMESTAMP('19-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('19-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2237, 1127, 3347, TO_TIMESTAMP('20-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('20-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2238, 1128, 3348, TO_TIMESTAMP('21-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('21-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2239, 1129, 3349, TO_TIMESTAMP('22-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('22-AUG-17 2:20:30.45 PM'));
INSERT INTO JOURNEY VALUES (2240, 1130, 3350, TO_TIMESTAMP('23-AUG-17 11:20:30.45 AM'), TO_TIMESTAMP('23-AUG-17 2:20:30.45 PM'));

CREATE TABLE PASSENGER
       (PASSENGERID SMALLINT NOT NULL,
        JOURNEYID SMALLINT NOT NULL,
        NAME VARCHAR(10),
        TICKETID SMALLINT,
        FOREIGN KEY (JOURNEYID) REFERENCES JOURNEY(JOURNEYID),
        CONSTRAINT FKTICKETID FOREIGN KEY (TICKETID) REFERENCES TICKET(TICKETID),
        PRIMARY KEY(PASSENGERID));  

INSERT INTO PASSENGER VALUES (4441, 2221, 'BOB', 7771);
INSERT INTO PASSENGER VALUES (4442, 2223, 'JACK', 7771);
INSERT INTO PASSENGER VALUES (4443, 2223, 'ABDI', 7772);
INSERT INTO PASSENGER VALUES (4444, 2224, 'JOSEPH', 7773);
INSERT INTO PASSENGER VALUES (4445, 2225, 'SARAH', 7772);
INSERT INTO PASSENGER VALUES (4446, 2226, 'HANA', 7772);
INSERT INTO PASSENGER VALUES (4447, 2227, 'NAILA', 7771);
INSERT INTO PASSENGER VALUES (4448, 2228, 'DORA', 7773);
INSERT INTO PASSENGER VALUES (4449, 2229, 'TIM', 7772);
INSERT INTO PASSENGER VALUES (4450, 2230, 'DARREL', 7773); 
           
INSERT INTO PASSENGER VALUES (4451, 2221, 'BOB', 7772);
INSERT INTO PASSENGER VALUES (4452, 2223, 'JILL', 7772);
INSERT INTO PASSENGER VALUES (4453, 2223, 'MOHAMMED', 7775);
INSERT INTO PASSENGER VALUES (4454, 2224, 'JAMES', 7774);
INSERT INTO PASSENGER VALUES (4455, 2225, 'SARAH', 7772);
INSERT INTO PASSENGER VALUES (4456, 2226, 'HANA', 7773);
INSERT INTO PASSENGER VALUES (4457, 2227, 'DONNA', 7772);
INSERT INTO PASSENGER VALUES (4458, 2230, 'DORA', 7774);
INSERT INTO PASSENGER VALUES (4459, 2230, 'HUGO', 7772);
INSERT INTO PASSENGER VALUES (4460, 2230, 'DARREL', 7773); 

INSERT INTO PASSENGER VALUES (4461, 2231, 'BOB', 7772);
INSERT INTO PASSENGER VALUES (4462, 2233, 'JILL', 7772);
INSERT INTO PASSENGER VALUES (4463, 2233, 'MOHAMMED', 7775);
INSERT INTO PASSENGER VALUES (4464, 2234, 'JAMES', 7774);
INSERT INTO PASSENGER VALUES (4465, 2235, 'SARAH', 7772);
INSERT INTO PASSENGER VALUES (4466, 2236, 'HANA', 7773);
INSERT INTO PASSENGER VALUES (4467, 2237, 'DONNA', 7772);
INSERT INTO PASSENGER VALUES (4468, 2238, 'DORA', 7774);
INSERT INTO PASSENGER VALUES (4469, 2239, 'HUGO', 7772);
INSERT INTO PASSENGER VALUES (4470, 2240, 'DARREL', 7773); 

-- BASIC QUERY 1 -- SHOWS THE NAME OF ALL THE PASSENGERS THAT HAVE TICKETS WORTH MORE THAN 200
SELECT PASSENGER.NAME FROM PASSENGER
JOIN TICKET ON PASSENGER.TICKETID = TICKET.TICKETID
WHERE TICKET.PRICE > 200;

-- BASIC QUERY 2 -- SHOWS THE NUMBER OF COUNTRIES BUSINESS PREMIER PASSENGERS END THEIR JOURNEY AT
SELECT COUNT(STATION.COUNTRY) FROM PASSENGER
JOIN TICKET ON PASSENGER.TICKETID = TICKET.TICKETID
JOIN JOURNEY ON PASSENGER.JOURNEYID = JOURNEY.JOURNEYID
JOIN ROUTE ON JOURNEY.ROUTEID = ROUTE.ROUTEID
JOIN STATION ON STATION.STATIONID = ROUTE.ENDSTATION
WHERE TICKET.PASSENGERTYPE = 'BUSINESS PREMIER';

-- MEDIUM QUERY 1 -- SHOWS THE NUMBER OF PASSENGERS ARRIVAL AND ORDER BY THE COUNTRY WITH THE MOST ARRIVALS
SELECT STATION.COUNTRY, COUNT(PASSENGER.PASSENGERID)
FROM PASSENGER
FULL OUTER JOIN JOURNEY ON PASSENGER.JOURNEYID = JOURNEY.JOURNEYID
FULL OUTER JOIN ROUTE ON ROUTE.ROUTEID = JOURNEY.ROUTEID
FULL OUTER JOIN STATION ON STATION.STATIONID = ROUTE.ENDSTATION
GROUP BY STATION.COUNTRY
ORDER BY COUNT(PASSENGER.PASSENGERID) DESC;

-- MEDIUM QUERY 2 -- SHOWS THE NUMBER OF TRAINS DEPARTING BETWEEN ('05-AUG-17') AND ('10-AUG-17') THAT HAVE A CAPACITY GREATER THAN 700 GROUPING BY WHETHER THEY ARE MODERN
SELECT TRAIN.ISMODERN, COUNT(*)
FROM JOURNEY
FULL OUTER JOIN TRAIN ON JOURNEY.TRAINID = TRAIN.TRAINID
WHERE JOURNEY.DEPARTURETIME 
BETWEEN TO_TIMESTAMP('05-AUG-17') AND TO_TIMESTAMP('10-AUG-17')
AND TRAIN.CAPACITY >= 700
GROUP BY TRAIN.ISMODERN;

-- ADVANCED QUERY 1 -- SHOWS THE AVERAGE PRICE ROUNDED TO 2 DP AND THE NUMBER OF DIFFERENT PASSENGER TYPES WHEN DEPARTING FROM A GIVEN STATION
SELECT STATION.NAME, ROUND(AVG(TICKET.PRICE), 2), COUNT(TICKET.PASSENGERTYPE)
FROM PASSENGER
JOIN TICKET ON PASSENGER.TICKETID = TICKET.TICKETID
FULL OUTER JOIN JOURNEY ON JOURNEY.JOURNEYID = PASSENGER.JOURNEYID
FULL OUTER JOIN ROUTE ON ROUTE.ROUTEID = JOURNEY.ROUTEID
FULL OUTER JOIN STATION ON STATION.STATIONID = ROUTE.STARTSTATION
GROUP BY STATION.NAME
ORDER BY ROUND(AVG(TICKET.PRICE), 2) ASC;

-- ADVANCED QUERY 2 -- SHOWS HOW MANY TIMES EACH STATION WAS VISITED ON ANY ROUTE THAT HAD STATIONS BETWEEN THE STARTING AND END STATION (STOPS)
SELECT S.STATIONID, ST.NAME, SUM(B.VAL) AS VISITED FROM STATIONS_BETWEEN_ROUTE S, 
(SELECT ROUTEID, COUNT(*) AS VAL
FROM JOURNEY 
GROUP BY ROUTEID) B, STATION ST
WHERE S.STATIONID = ST.STATIONID AND S.ROUTEID = B.ROUTEID
GROUP BY S.STATIONID, ST.NAME

-- ADVANCED QUERY 3 -- SHOWS HOW MANY TIMES EACH EMPLOYEE HAS BEEN PART OF ANY CREW ON ANY JOURNEY
SELECT E.NAME, S.EMPLOYEE_NUMBER, SUM(S.WORKED) AS SHIFTS FROM EMPLOYEE E, (
SELECT EMPLOYEE_NUMBER, WORKED FROM (
SELECT C.*, W.WORKED FROM CREW C, 
(SELECT T.CREWID, COUNT(*) AS WORKED FROM JOURNEY J, TRAIN T
WHERE J.TRAINID = T.TRAINID
GROUP BY  T.CREWID) W 
WHERE C.CREWID = W.CREWID
) EMPLOYEE_NUMBER
unpivot (EMPLOYEE_NUMBER for employee in (
    DRIVER1,
    DRIVER2,
    HEADCONDUCTOR,
    SECONDCONDUCTOR,
    SECUIRITYGUARD1,
    SECUIRITYGUARD2,
    SERVICEMEMBER
  ))
) S
WHERE S.EMPLOYEE_NUMBER = E.EMPLOYEEID
GROUP BY EMPLOYEE_NUMBER, E.NAME